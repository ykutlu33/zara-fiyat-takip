name: Zara Fiyat Takip

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-price:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests playwright beautifulsoup4
          playwright install firefox
          playwright install-deps

      - name: Check price
        run: |
          python << 'PYEND'
          import requests
          import os
          import time
          import json
          import random
          from bs4 import BeautifulSoup
          from playwright.sync_api import sync_playwright

          # ===== AYARLAR =====
          TOKEN = "8375130122:AAHXVaMo-XXZvkd-MEsoOdEVpdtkqc50psg"
          CHAT  = "1234645010"
          URL   = "https://www.zara.com/tr/tr/cift-tarafli-cift-yuzlu-ceket-p06318254.html"
          # ===================

          def send_telegram(msg):
              try:
                  requests.post(f"https://api.telegram.org/bot{TOKEN}/sendMessage", json={"chat_id": CHAT, "text": msg, "parse_mode": "HTML", "disable_web_page_preview": True})
              except:
                  pass

          # --- TEMIZLIK (Eski Fiyat Karismasini Onle) ---
          # Eger kaydedilen URL ile su anki URL farkliysa dosyalari sil
          if os.path.exists("url.txt"):
              saved_url = open("url.txt").read().strip()
              if saved_url != URL:
                  print("‚ö†Ô∏è YENƒ∞ Lƒ∞NK TESPƒ∞T EDƒ∞LDƒ∞! Eski hafƒ±za siliniyor...")
                  if os.path.exists("price.txt"): os.remove("price.txt")
                  if os.path.exists("notify.txt"): os.remove("notify.txt")

          print("Firefox ile siteye gidiliyor...")
          price = None
          product_name = "Zara √úr√ºn√º"

          try:
              with sync_playwright() as p:
                  browser = p.firefox.launch(headless=True)
                  context = browser.new_context(
                      user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0"
                  )
                  page = context.new_page()
                  page.goto(URL, timeout=90000, wait_until="domcontentloaded")
                  time.sleep(random.uniform(6, 10)) # Biraz daha uzun bekle
                  content = page.content()
                  browser.close()

                  soup = BeautifulSoup(content, 'html.parser')

                  # 1. YONTEM: Zara'nin Guncel CSS Siniflari (En Guvenilir)
                  # Zara fiyatlari genelde 'money-amount__main' veya 'price-current__amount' icindedir
                  css_classes = [
                      "span.price-current__amount span.money-amount__main", 
                      "span.money-amount__main", 
                      "div.product-detail-info__price-amount span"
                  ]
                  
                  for css in css_classes:
                      element = soup.select_one(css)
                      if element:
                          text = element.get_text().strip()
                          print(f"CSS Buldu ({css}): {text}")
                          clean = text.replace("TL", "").replace("TRY", "").replace(".", "").replace(",", ".").strip()
                          try:
                              val = float(clean)
                              if val > 100: # Mantikli bir fiyat mi?
                                  price = val
                                  break
                          except:
                              continue

                  # Isim Cekme
                  h1 = soup.find("h1")
                  if h1: product_name = h1.get_text().strip()

                  # 2. YONTEM: JSON (Yedek)
                  if not price:
                      scripts = soup.find_all('script', type='application/ld+json')
                      for script in scripts:
                          try:
                              data = json.loads(script.string)
                              if isinstance(data, list): data = data[0]
                              if data.get('@type') == 'Product':
                                  offers = data.get('offers', {})
                                  if isinstance(offers, list): offers = offers[0]
                                  if offers.get('price'):
                                      price = float(offers['price'])
                                      break
                          except:
                              continue

          except Exception as e:
              print(f"Hata: {e}")
              exit(1)

          if not price:
              print("Fiyat bulunamadi.")
              send_telegram(f"‚ö†Ô∏è <b>HATA:</b> Fiyat √ßekilemedi. Manuel kontrol ediniz.\nLink: {URL}")
              exit(0)

          # --- ISLEMLER ---
          formatted = f"{price:,.2f} TL".replace(",", "X").replace(".", ",").replace("X", ".")
          print(f"Tespit Edilen Fiyat: {formatted}")
          
          last_price = "0"
          last_notify = ""

          if os.path.exists("price.txt"): last_price = open("price.txt").read().strip() or "0"
          if os.path.exists("notify.txt"): last_notify = open("notify.txt").read().strip()

          now = int(time.time())
          msg = None

          # ILK DEFA CALISIYORSA veya SIFIRLANDIYSA
          if last_price == "0":
              msg = (
                  f"üõçÔ∏è <b>TAKƒ∞P BA≈ûLADI (Sƒ±fƒ±rlandƒ±)</b>\n\n"
                  f"üì¶ <b>√úr√ºn:</b> {product_name}\n"
                  f"üí∞ <b>Fiyat:</b> {formatted}\n\n"
                  f"üîó <a href='{URL}'>√úr√ºne Git</a>\n\n"
                  f"‚ÑπÔ∏è √ñnceki √ºr√ºn hafƒ±zasƒ± silindi, yeni √ºr√ºn takipte."
              )
          
          # FIYAT DEGISIMI
          elif float(last_price) != price:
              old_fmt = f"{float(last_price):,.2f} TL".replace(",", "X").replace(".", ",").replace("X", ".")
              msg = (
                  f"üö® <b>Fƒ∞YAT DEƒûƒ∞≈ûTƒ∞!</b>\n\n"
                  f"üì¶ {product_name}\n"
                  f"‚ùå Eski: {old_fmt}\n"
                  f"‚úÖ Yeni: <b>{formatted}</b>\n\n"
                  f"üîó <a href='{URL}'>√úr√ºne Git</a>"
              )

          # HATIRLATMA
          elif last_notify and (now - int(last_notify)) >= 21600:
              msg = (
                  f"‚è∞ <b>HATIRLATMA</b>\n\n"
                  f"üì¶ {product_name}\n"
                  f"üí∞ Fiyat hala: <b>{formatted}</b>\n\n"
                  f"üîó <a href='{URL}'>√úr√ºne Git</a>"
              )

          if msg:
              send_telegram(msg)
              with open("notify.txt", "w") as f: f.write(str(now))

          with open("price.txt", "w") as f: f.write(str(price))
          with open("url.txt", "w") as f: f.write(URL)
          PYEND

      - name: Commit files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          touch price.txt notify.txt url.txt
          git add -A
          git diff --staged --quiet || git commit -m "Update price"
          git push
