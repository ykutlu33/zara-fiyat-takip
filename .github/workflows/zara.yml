name: Zara Fiyat Takip

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-price:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests playwright beautifulsoup4
          playwright install chromium
          playwright install-deps

      - name: Check price
        run: |
          python << 'PYEND'
          import requests
          import os
          import time
          import random
          from bs4 import BeautifulSoup
          from playwright.sync_api import sync_playwright

          # ===== KISISEL AYARLARINIZ EKLENDI =====
          TOKEN = "8375130122:AAHXVaMo-XXZvkd-MEsoOdEVpdtkqc50psg"
          CHAT  = "1234645010"
          URL   = "https://www.zara.com/tr/tr/hayvan-desenli-kisa-suni-kurk-kaban-zw-collection-p04369240.html?v1=489488534"
          # =======================================

          def send_telegram(msg):
              try:
                  url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
                  requests.post(url, json={"chat_id": CHAT, "text": msg})
              except Exception as e:
                  print(f"Telegram gonderilemedi: {e}")

          print("Playwright baslatiliyor...")
          
          price = None

          try:
              with sync_playwright() as p:
                  # Bot korumasini asmak icin ozel parametreler
                  browser = p.chromium.launch(
                      headless=True,
                      args=[
                          '--disable-blink-features=AutomationControlled',
                          '--no-sandbox',
                          '--disable-setuid-sandbox'
                      ]
                  )
                  
                  # Gercek bir iPhone gibi davranalim (Mobil gorunum bazen daha basittir)
                  context = browser.new_context(
                      user_agent="Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1"
                  )
                  
                  page = context.new_page()
                  
                  # Siteye git
                  print("Site yukleniyor...")
                  page.goto(URL, timeout=90000)
                  
                  # Yuklenmesi icin rastgele bekle (Insan taklidi)
                  time.sleep(random.uniform(5, 8))
                  
                  # HTML icerigini al
                  content = page.content()
                  browser.close()
                  
                  # BeautifulSoup ile analiz et
                  soup = BeautifulSoup(content, 'html.parser')
                  
                  # YONTEM 1: Meta verisi (En temiz veri)
                  meta = soup.find("meta", property="product:price:amount")
                  if meta:
                      try:
                          price = float(meta["content"])
                          print(f"Meta etiketinden fiyat bulundu: {price}")
                      except:
                          pass
                  
                  # YONTEM 2: G√∂r√ºn√ºr fiyat etiketleri (Zara guncel classlari)
                  if not price:
                      classes = ["price-current__amount", "money-amount__main", "price__amount"]
                      for cls in classes:
                          tag = soup.find(class_=cls)
                          if tag:
                              txt = tag.get_text().strip()
                              clean = txt.replace("TL", "").replace("TRY", "").replace(".", "").replace(",", ".").strip()
                              try:
                                  price = float(clean)
                                  print(f"HTML class ({cls}) ile bulundu: {price}")
                                  break
                              except:
                                  continue

          except Exception as e:
              print(f"HATA: {e}")
              # Kritik hata olursa bildirim at
              send_telegram(f"‚ö†Ô∏è HATA: Kod √ßalƒ±≈üƒ±rken sorun olu≈ütu.\n{str(e)}")
              exit(1)

          # Fiyat hala yoksa
          if not price:
              print("Fiyat bulunamadi.")
              # Dosya yoksa olustur
              if not os.path.exists("price.txt"):
                  with open("price.txt", "w") as f: f.write("0")
              
              send_telegram(f"‚ö†Ô∏è Dƒ∞KKAT: √úr√ºn sayfasƒ±na girildi ama fiyat okunamadƒ±.\n\nZara eri≈üimi engellemi≈ü olabilir.\n\nüîó {URL}")
              exit(0)

          # Fiyat formatlama
          formatted = f"{price:,.2f} TL".replace(",", "X").replace(".", ",").replace("X", ".")
          print(f"Guncel Fiyat: {formatted}")

          # Kayitli verileri oku
          last_price = "0"
          last_notify = ""

          if os.path.exists("price.txt"):
              with open("price.txt", "r") as f: last_price = f.read().strip() or "0"
          
          if os.path.exists("notify.txt"):
              with open("notify.txt", "r") as f: last_notify = f.read().strip()

          now = int(time.time())
          msg = None

          # Mantik Kontrolu
          if last_price == "0":
              msg = f"üõçÔ∏è TAKƒ∞P BA≈ûLADI\n\nüí∞ Fiyat: {formatted}\n\nüîó {URL}"
          
          elif float(last_price) != price:
              old = float(last_price)
              diff = price - old
              emoji = "üìâ" if diff < 0 else "üìà"
              msg = f"{emoji} Fƒ∞YAT DEƒûƒ∞≈ûTƒ∞!\n\nEski: {old:,.2f} TL\nYeni: {formatted}\nFark: {diff:,.2f} TL\n\nüîó {URL}"
          
          elif last_notify and (now - int(last_notify) if last_notify.isdigit() else 999999) >= 21600:
              msg = f"‚è∞ HATIRLATMA\n\nFiyat hala: {formatted}\n\nüîó {URL}"
          else:
              print("Fiyat ayni, bildirim zamani gelmedi.")

          if msg:
              send_telegram(msg)
              with open("notify.txt", "w") as f: f.write(str(now))

          with open("price.txt", "w") as f: f.write(str(price))
          PYEND

      - name: Commit files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          touch price.txt notify.txt
          git add -A
          git diff --staged --quiet || git commit -m "Update price"
          git push
