name: Zara Fiyat Takip

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-price:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests playwright
          playwright install chromium
          playwright install-deps

      - name: Check price
        run: |
          python << 'PYEND'
          import requests
          import os
          import time
          from playwright.sync_api import sync_playwright

          # ===== AYARLAR =====
          TOKEN = "TELEGRAM_BOT_TOKEN"
          CHAT  = "TELEGRAM_CHAT_ID"
          URL   = "https://www.zara.com/tr/tr/hayvan-desenli-kisa-suni-kurk-kaban-zw-collection-p04369240.html?v1=489488534"
          # ===================

          def send_telegram(msg):
              try:
                  requests.post(
                      f"https://api.telegram.org/bot{TOKEN}/sendMessage",
                      json={"chat_id": CHAT, "text": msg}
                  )
              except Exception as e:
                  print("Telegram hata:", e)

          price_holder = {"price": None}

          print("Tarayƒ±cƒ± ba≈ülatƒ±lƒ±yor")

          with sync_playwright() as p:
              browser = p.chromium.launch(headless=True)
              context = browser.new_context(
                  locale="tr-TR",
                  timezone_id="Europe/Istanbul",
                  user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36"
              )
              page = context.new_page()

              def handle_response(response):
                  try:
                      if "product" in response.url and response.request.method == "GET":
                          data = response.json()
                          if isinstance(data, dict) and "price" in data and "value" in data["price"]:
                              price_holder["price"] = data["price"]["value"] / 100
                  except:
                      pass

              page.on("response", handle_response)

              page.goto(URL, timeout=60000)
              page.wait_for_timeout(8000)
              browser.close()

          price = price_holder["price"]

          if not price:
              send_telegram(
                  "‚ö†Ô∏è Fiyat √ßekilemedi\n\n"
                  "Zara API yapƒ±sƒ± deƒüi≈ümi≈ü veya bot korumasƒ± engellemi≈ü olabilir\n\n"
                  f"{URL}"
              )
              exit(0)

          formatted = f"{price:,.2f} TL".replace(",", "X").replace(".", ",").replace("X", ".")

          last_price = "0"
          last_notify = ""

          if os.path.exists("price.txt"):
              last_price = open("price.txt").read().strip() or "0"

          if os.path.exists("notify.txt"):
              last_notify = open("notify.txt").read().strip()

          now = int(time.time())
          msg = None

          if last_price == "0":
              msg = (
                  "üõçÔ∏è TAKƒ∞P BA≈ûLADI\n\n"
                  f"üí∞ Fiyat: {formatted}\n\n"
                  f"{URL}"
              )

          elif float(last_price) != price:
              old = float(last_price)
              diff = price - old
              trend = "üìâ" if diff < 0 else "üìà"
              msg = (
                  f"{trend} Fƒ∞YAT DEƒûƒ∞≈ûTƒ∞\n\n"
                  f"Eski: {old:.2f} TL\n"
                  f"Yeni: {formatted}\n"
                  f"Fark: {diff:.2f} TL\n\n"
                  f"{URL}"
              )

          elif last_notify.isdigit() and now - int(last_notify) >= 21600:
              msg = (
                  "‚è∞ HATIRLATMA\n\n"
                  f"üí∞ Fiyat hala: {formatted}\n\n"
                  f"{URL}"
              )

          if msg:
              send_telegram(msg)
              open("notify.txt", "w").write(str(now))

          open("price.txt", "w").write(str(price))
          PYEND

      - name: Commit files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          touch price.txt notify.txt
          git add -A
          git diff --staged --quiet || git commit -m "Update price"
          git push
