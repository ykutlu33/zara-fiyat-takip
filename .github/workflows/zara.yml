name: Zara Fiyat Takip

on:
  schedule:
    - cron: '*/15 * * * *' # Zara √ßok sƒ±k isteƒüi engelleyebilir, 15 dk idealdir.
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-price:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests beautifulsoup4
      
      - name: Check price
        run: |
          python << 'PYEND'
          import requests
          import os
          import time
          from bs4 import BeautifulSoup

          # GUVENLIK UYARISI: Bu token ve chat id'yi GitHub Secrets icine almaniz onerilir.
          TOKEN = "8375130122:AAHXVaMo-XXZvkd-MEsoOdEVpdtkqc50psg"
          CHAT = "1234645010"
          URL = "https://www.zara.com/tr/tr/hayvan-desenli-kisa-suni-kurk-kaban-zw-collection-p04369240.html?v1=489488534"

          print("Fiyat kontrol ediliyor...")

          # Daha guclu bir User-Agent kullanalim
          headers = {
              "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
              "Accept-Language": "tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7"
          }
          
          try:
              response = requests.get(URL, headers=headers, timeout=30)
          except Exception as e:
              print(f"Hata: Siteye erisilemedi. {e}")
              exit(1)

          soup = BeautifulSoup(response.content, 'html.parser')
          price = None

          # YONTEM 1: Meta etiketlerinden fiyat bulma (En garantisi budur)
          meta_price = soup.find("meta", property="product:price:amount")
          if not meta_price:
              meta_price = soup.find("meta", property="og:price:amount")
          
          if meta_price:
              try:
                  price = float(meta_price["content"])
                  print(f"Meta etiketinden fiyat bulundu: {price}")
              except:
                  pass

          # YONTEM 2: Eger meta yoksa script icindeki JSON verisini veya span'lari dene
          if not price:
              # Zara genelde fiyatƒ± 'price-current__amount' class'ƒ±nda tutar
              span_price = soup.find("span", class_="price-current__amount")
              if span_price:
                  clean_text = span_price.text.replace("TL", "").replace(".", "").replace(",", ".").strip()
                  try:
                      price = float(clean_text)
                      print(f"HTML span icinden fiyat bulundu: {price}")
                  except:
                      pass

          if not price:
              print("HATA: Fiyat hicbir yontemle bulunamadi! HTML yapisi degismis olabilir.")
              # Hata ayiklama icin HTML'in kucuk bir kismini yazdiralim
              print(str(soup)[:500]) 
              exit(0)

          formatted = f"{price:,.2f} TL".replace(",", "X").replace(".", ",").replace("X", ".")
          print(f"Guncel islenen fiyat: {formatted}")

          last = ""
          last_notify = ""
          
          if os.path.exists("price.txt"):
              with open("price.txt", "r") as f:
                  last = f.read().strip()
          
          if os.path.exists("notify.txt"):
              with open("notify.txt", "r") as f:
                  last_notify = f.read().strip()

          print(f"Onceki kayitli fiyat: {last}")
          now = int(time.time())
          msg = None

          if not last:
              msg = f"üõçÔ∏è ZARA TAKƒ∞P BA≈ûLADI!\n\nüì¶ K√ºrk Kaban\nüí∞ Fiyat: {formatted}\n\nüîó {URL}"
              print("Ilk calisma!")

          elif float(last) != price:
              old = float(last)
              diff = price - old
              old_fmt = f"{old:,.2f} TL".replace(",", "X").replace(".", ",").replace("X", ".")
              
              emoji = "üìâ" if diff < 0 else "üìà"
              msg = f"{emoji} Fƒ∞YAT DEƒûƒ∞≈ûTƒ∞!\n\nEski: {old_fmt}\nYeni: {formatted}\nFark: {diff:.2f} TL\n\nüîó {URL}"
              print("Fiyat degisti!")

          elif last_notify and (now - int(last_notify)) >= 21600: # 6 saat
              msg = f"‚è∞ HATIRLATMA\n\nüí∞ Fiyat hala: {formatted}\n\nüîó {URL}"
              print("Hatirlatma zamani!")

          else:
              print("Fiyat ayni, bildirim zamani gelmedi.")

          if msg:
              try:
                  r = requests.post(f"https://api.telegram.org/bot{TOKEN}/sendMessage", json={"chat_id": CHAT, "text": msg})
                  print(f"Telegram Yaniti: {r.status_code}")
                  
                  if r.status_code == 200:
                      with open("notify.txt", "w") as f:
                          f.write(str(now))
                  else:
                      print(r.text)
              except Exception as e:
                  print(f"Telegram gonderim hatasi: {e}")

          # Fiyati her zaman guncelle
          with open("price.txt", "w") as f:
              f.write(str(price))
          PYEND
      
      - name: Commit files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          # Hata almamak i√ßin dosyalar yoksa bo≈ü olarak olu≈ütur
          touch price.txt notify.txt
          
          # Spesifik isim yerine t√ºm degisiklikleri ekle (-A)
          git add -A
          
          # Eƒüer deƒüi≈üiklik varsa commit yap, yoksa hata verme ve devam et
          git diff --staged --quiet || git commit -m "Update price data"
          
          # Hata olsa bile push yapmayƒ± dene
          git push
