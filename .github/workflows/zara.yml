name: Zara Fiyat Takip

on:
  schedule:
    - cron: '*/30 * * * *' # 30 dakikada bir (Cok sik yapip dikkat cekmeyelim)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-price:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests playwright beautifulsoup4
          playwright install firefox
          playwright install-deps

      - name: Check price
        run: |
          python << 'PYEND'
          import requests
          import os
          import time
          import json
          import random
          from bs4 import BeautifulSoup
          from playwright.sync_api import sync_playwright

          # ===== AYARLAR =====
          TOKEN = "8375130122:AAHXVaMo-XXZvkd-MEsoOdEVpdtkqc50psg"
          CHAT  = "1234645010"
          URL   = "https://www.zara.com/tr/tr/hayvan-desenli-kisa-suni-kurk-kaban-zw-collection-p04369240.html?v1=489488534"
          # ===================

          def send_telegram(msg):
              try:
                  requests.post(f"https://api.telegram.org/bot{TOKEN}/sendMessage", json={"chat_id": CHAT, "text": msg})
              except:
                  pass

          print("Firefox tarayicisi hazirlaniyor...")
          price = None

          try:
              with sync_playwright() as p:
                  # Chrome yerine FIREFOX kullaniyoruz (Daha az engellenir)
                  browser = p.firefox.launch(headless=True)
                  
                  # Mozilla Firefox User Agent
                  context = browser.new_context(
                      user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0",
                      viewport={"width": 1920, "height": 1080}
                  )
                  
                  page = context.new_page()
                  
                  # Bot olmadigimizi kanitlamak icin fare hareketleri simulesi (bazen ise yarar)
                  print("Siteye gidiliyor...")
                  page.goto(URL, timeout=90000, wait_until="domcontentloaded")
                  
                  # Sayfanin tam yuklenmesi icin rastgele bekle
                  time.sleep(random.uniform(5, 8))
                  
                  content = page.content()
                  browser.close()

                  soup = BeautifulSoup(content, 'html.parser')

                  # --- YONTEM 1: JSON-LD (Google Verisi) ---
                  # Bu veri Google icin konulur ve genelde bot korumasina takilmaz.
                  scripts = soup.find_all('script', type='application/ld+json')
                  for script in scripts:
                      try:
                          data = json.loads(script.string)
                          # Bazen liste olarak doner
                          if isinstance(data, list):
                              data = data[0]
                          
                          # Urun semasini bulalim
                          if data.get('@type') == 'Product':
                              offers = data.get('offers', {})
                              # Fiyat bazen liste olabilir
                              if isinstance(offers, list):
                                  offers = offers[0]
                              
                              price_val = offers.get('price')
                              if price_val:
                                  price = float(price_val)
                                  print(f"BINGO! JSON verisinden fiyat bulundu: {price}")
                                  break
                      except:
                          continue

                  # --- YONTEM 2: Ozel Regex (Sayfadaki tum sayilari tara) ---
                  if not price:
                      import re
                      # "3.590 TL" veya "3590 TL" gibi ifadeleri arar
                      text_content = soup.get_text()
                      # Zara formatina ozel regex
                      matches = re.findall(r'(\d{1,2}(?:\.?\d{3})*,\d{2})\s*(?:TL|TRY)', text_content)
                      
                      possible_prices = []
                      for m in matches:
                          clean = float(m.replace(".", "").replace(",", "."))
                          if clean > 100: # 100 TL alti urun olmaz diye varsayiyoruz (yanlis veriyi eler)
                              possible_prices.append(clean)
                      
                      if possible_prices:
                          # Genelde en yuksek fiyat gercek fiyattir (taksit seceneklerini elemek icin)
                          price = max(possible_prices)
                          print(f"Regex ile bulundu: {price}")

          except Exception as e:
              send_telegram(f"‚ö†Ô∏è HATA: Kod calisirken patladi:\n{str(e)}")
              exit(1)

          if not price:
              # Fiyat bulunamazsa onceki degeri koru ki hata vermesin
              print("Fiyat bulunamadi, eri≈üim engellenmi≈ü olabilir.")
              if not os.path.exists("price.txt"):
                  with open("price.txt", "w") as f: f.write("0")
              
              send_telegram(f"‚ö†Ô∏è Fiyat hala okunamiyor. Zara GitHub IP'lerini engelliyor olabilir. Manuel kontrol ediniz.\n{URL}")
              exit(0)

          # --- ISLEMLER ---
          formatted = f"{price:,.2f} TL".replace(",", "X").replace(".", ",").replace("X", ".")
          
          last_price = "0"
          last_notify = ""

          if os.path.exists("price.txt"):
              with open("price.txt", "r") as f: last_price = f.read().strip() or "0"
          if os.path.exists("notify.txt"):
              with open("notify.txt", "r") as f: last_notify = f.read().strip()

          now = int(time.time())
          msg = None

          if last_price == "0":
              msg = f"‚úÖ BA≈ûARILI! Takip Ba≈üladƒ± (Firefox Modu)\n\nüí∞ Fiyat: {formatted}\n\nüîó {URL}"
          
          elif float(last_price) != price:
              msg = f"üö® Fƒ∞YAT DEƒûƒ∞≈ûTƒ∞!\n\nEski: {last_price} TL\nYeni: {formatted}\n\nüîó {URL}"
          
          elif last_notify and (now - int(last_notify)) >= 21600:
               msg = f"‚è∞ Bildirim: Fiyat hala {formatted}\n{URL}"

          if msg:
              send_telegram(msg)
              with open("notify.txt", "w") as f: f.write(str(now))

          with open("price.txt", "w") as f: f.write(str(price))
          PYEND

      - name: Commit files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          touch price.txt notify.txt
          git add -A
          git diff --staged --quiet || git commit -m "Update price"
          git push
