name: Zara Fiyat Takip

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-price:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests playwright beautifulsoup4
          playwright install firefox
          playwright install-deps

      - name: Check price
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT: ${{ secrets.TELEGRAM_CHAT }}
        run: |
          python << 'PYEND'
          import requests
          import os
          import time
          import json
          import random
          from bs4 import BeautifulSoup
          from playwright.sync_api import sync_playwright

          # ===== AYARLAR =====
          TOKEN = os.environ.get("TELEGRAM_TOKEN")
          CHAT  = os.environ.get("TELEGRAM_CHAT")
          URL   = "https://www.zara.com/tr/tr/cift-tarafli-cift-yuzlu-ceket-p06318254.html"
          # ===================

          def send_telegram(msg):
              url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
              payload = {"chat_id": CHAT, "text": msg}
              try:
                  r = requests.post(url, json=payload)
                  print(f"Telegram yaniti: {r.status_code} - {r.text}")
                  return r.status_code == 200
              except Exception as e:
                  print(f"Mesaj gonderilemedi: {e}")
                  return False

          # DEBUG: Her calistirmada bilgi ver
          print(f"Token var mi: {bool(TOKEN)}")
          print(f"Chat var mi: {bool(CHAT)}")

          # TEST MESAJI (ilk seferde acik birak)
          send_telegram("üîÑ Zara fiyat kontrolu basladi...")

          print("Firefox baslatiliyor...")
          price = None
          product_name = "Zara Urunu"

          try:
              with sync_playwright() as p:
                  browser = p.firefox.launch(headless=True)
                  context = browser.new_context(
                      user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0"
                  )
                  page = context.new_page()
                  page.goto(URL, timeout=90000, wait_until="domcontentloaded")
                  time.sleep(random.uniform(5, 8))
                  content = page.content()
                  browser.close()

                  soup = BeautifulSoup(content, 'html.parser')

                  # YONTEM 1: JSON
                  scripts = soup.find_all('script', type='application/ld+json')
                  for script in scripts:
                      try:
                          data = json.loads(script.string)
                          if isinstance(data, list): data = data[0]
                          if data.get('@type') == 'Product':
                              if 'name' in data: product_name = data['name']
                              offers = data.get('offers', {})
                              if isinstance(offers, list): offers = offers[0]
                              if offers.get('price'):
                                  price = float(offers['price'])
                                  break
                      except:
                          continue
                  
                  # YONTEM 2: CSS (Yedek)
                  if not price:
                      candidates = soup.select("span.money-amount__main, div.product-detail-info__price-amount span")
                      for tag in candidates:
                          txt = tag.get_text().strip()
                          clean = txt.replace("TL", "").replace("TRY", "").replace(".", "").replace(",", ".").strip()
                          try:
                              val = float(clean)
                              if val > 100:
                                  price = val
                                  break
                          except:
                              continue

          except Exception as e:
              send_telegram(f"‚ùå HATA: {str(e)[:200]}")
              exit(1)

          if not price:
              send_telegram(f"‚ö†Ô∏è Fiyat okunamadi!\nLink: {URL}")
              exit(0)

          # --- ISLEMLER ---
          formatted = f"{price:,.2f} TL"
          
          last_price = 0
          if os.path.exists("price.txt"):
              try:
                  last_price = float(open("price.txt").read().strip())
              except:
                  last_price = 0

          print(f"Eski: {last_price}, Yeni: {price}")

          if last_price == 0:
              send_telegram(f"‚úÖ TAKIP BASLADI\n\nüì¶ {product_name}\nüí∞ {formatted}\n\nüîó {URL}")
          elif last_price != price:
              if price < last_price:
                  send_telegram(f"üî• FIYAT DUSTU!\n\nüì¶ {product_name}\n‚ùå Eski: {last_price:,.2f} TL\n‚úÖ Yeni: {formatted}\n\nüîó {URL}")
              else:
                  send_telegram(f"üìà Fiyat artti\n\nEski: {last_price:,.2f} TL\nYeni: {formatted}")

          with open("price.txt", "w") as f:
              f.write(str(price))
          PYEND

      - name: Commit files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          touch price.txt
          git add -A
          git diff --staged --quiet || git commit -m "Update price"
          git push
