name: Zara Fiyat Takip

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-price:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install requests
        run: pip install requests
      
      - name: Check price
        run: |
          python << 'PYEND'
          import requests, re, os, time

          TOKEN = "8375130122:AAHXVaMo-XXZvkd-MEsoOdEVpdtkqc50psg"
          CHAT = "1234645010"
          URL = "https://www.zara.com/tr/tr/hayvan-desenli-kisa-suni-kurk-kaban-zw-collection-p04369240.html?v1=489488534"

          print("Fiyat kontrol ediliyor...")

          headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}
          response = requests.get(URL, headers=headers, timeout=30)
          prices = re.findall(r"(\d{1,3}(?:\.\d{3})*,\d{2})\s*TL", response.text)

          print(f"Bulunan fiyatlar: {prices}")

          if not prices:
              print("Fiyat bulunamadi!")
              exit(0)

          float_prices = [float(p.replace(".", "").replace(",", ".")) for p in prices]
          price = min(float_prices)
          formatted = f"{price:,.2f} TL".replace(",", "X").replace(".", ",").replace("X", ".")
          print(f"Guncel fiyat: {formatted}")

          last = ""
          last_notify = ""
          if os.path.exists("price.txt"):
              with open("price.txt") as f:
                  last = f.read().strip()
          if os.path.exists("notify.txt"):
              with open("notify.txt") as f:
                  last_notify = f.read().strip()

          print(f"Onceki fiyat: {last}")
          now = int(time.time())
          msg = None

          if not last:
              msg = f"üõçÔ∏è ZARA Fƒ∞YAT TAKƒ∞Bƒ∞ BA≈ûLADI!\n\nüì¶ ZW Collection Hayvan Desenli K√ºrk Kaban\nüí∞ Fiyat: {formatted}\n\n‚úÖ Fiyat deƒüi≈üince bildirim alacaksƒ±nƒ±z!\n\nüîó {URL}"
              print("Ilk calisma!")

          elif float(last) != price:
              old = float(last)
              diff = price - old
              pct = (diff / old) * 100
              old_fmt = f"{old:,.2f} TL".replace(",", "X").replace(".", ",").replace("X", ".")
              if diff < 0:
                  msg = f"üéâüìâ FIYAT DUSTU!\n\nEski: {old_fmt}\nYeni: {formatted}\n\nFark: {abs(diff):.2f} TL ({abs(pct):.1f}%)\n\nüîó {URL}"
              else:
                  msg = f"üìà FIYAT ARTTI!\n\nEski: {old_fmt}\nYeni: {formatted}\n\nFark: {abs(diff):.2f} TL ({abs(pct):.1f}%)\n\nüîó {URL}"
              print("Fiyat degisti!")

          elif last_notify and (now - int(last_notify)) >= 21600:
              msg = f"‚è∞ HATIRLATMA\n\nüí∞ Fiyat hala: {formatted}\n\nüîó {URL}"
              print("6 saat hatirlatma!")

          else:
              print("Fiyat ayni, bildirim yok.")

          if msg:
              r = requests.post(f"https://api.telegram.org/bot{TOKEN}/sendMessage", json={"chat_id": CHAT, "text": msg})
              print(f"Telegram: {r.status_code}")
              with open("notify.txt", "w") as f:
                  f.write(str(now))

          with open("price.txt", "w") as f:
              f.write(str(price))
          PYEND

      - name: Commit
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add -A
          git diff --staged --quiet || git commit -m "Update price"
          git push
