name: Zara Fiyat Takip

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  check-price:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Get last price and check
        run: |
          if [ -f price.txt ]; then
            export LAST_PRICE=$(cat price.txt)
          fi
          if [ -f last_notify.txt ]; then
            export LAST_NOTIFY=$(cat last_notify.txt)
          fi
          
          python3 -c "
          import requests, re, os, time

          TOKEN = '8375130122:AAHXVaMo-XXZvkd-MEsoOdEVpdtkqc50psg'
          CHAT = '1234645010'
          URL = 'https://www.zara.com/tr/tr/hayvan-desenli-kisa-suni-kurk-kaban-zw-collection-p04369240.html?v1=489488534'

          headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
          response = requests.get(URL, headers=headers, timeout=30)
          prices = re.findall(r'(\d{1,3}(?:\.\d{3})*,\d{2})\s*TL', response.text)

          if prices:
              float_prices = [float(p.replace('.', '').replace(',', '.')) for p in prices]
              price = min(float_prices)
              formatted = f'{price:,.2f} TL'.replace(',', 'X').replace('.', ',').replace('X', '.')
              print(f'Fiyat: {formatted}')

              last = os.environ.get('LAST_PRICE', '')
              last_notify = os.environ.get('LAST_NOTIFY', '')
              now = int(time.time())
              
              # Ä°lk Ã§alÄ±ÅŸma - hoÅŸ geldin mesajÄ±
              if not last:
                  msg = f'ğŸ›ï¸ ZARA FÄ°YAT TAKÄ°BÄ° BAÅLADI!\n\nğŸ“¦ ZW Collection Hayvan Desenli KÃ¼rk Kaban\nğŸ’° Åu anki fiyat: {formatted}\n\nâœ… Fiyat deÄŸiÅŸince bildirim alacaksÄ±nÄ±z!\nâ° 6 saatte bir hatÄ±rlatma gelecek.\n\nğŸ”— {URL}'
                  requests.post(f'https://api.telegram.org/bot{TOKEN}/sendMessage', json={'chat_id': CHAT, 'text': msg})
                  print('Ilk bildirim gonderildi!')
                  with open('last_notify.txt', 'w') as f:
                      f.write(str(now))
              
              # Fiyat deÄŸiÅŸti
              elif float(last) != price:
                  old = float(last)
                  diff = price - old
                  pct = (diff / old) * 100
                  old_fmt = f'{old:,.2f} TL'.replace(',', 'X').replace('.', ',').replace('X', '.')
                  diff_fmt = f'{abs(diff):,.2f} TL'.replace(',', 'X').replace('.', ',').replace('X', '.')
                  if diff < 0:
                      msg = f'ğŸ‰ğŸ“‰ FIYAT DUSTU!\n\nğŸ“¦ ZW Collection Hayvan Desenli KÃ¼rk Kaban\n\nğŸ’° Eski: {old_fmt}\nğŸ’° Yeni: {formatted}\n\nâœ… {diff_fmt} UCUZLADI! ({abs(pct):.1f}%)\n\nğŸ”— {URL}'
                  else:
                      msg = f'ğŸ“ˆâš ï¸ FIYAT ARTTI!\n\nğŸ“¦ ZW Collection Hayvan Desenli KÃ¼rk Kaban\n\nğŸ’° Eski: {old_fmt}\nğŸ’° Yeni: {formatted}\n\nâš ï¸ {diff_fmt} ZAMLANDI! ({abs(pct):.1f}%)\n\nğŸ”— {URL}'
                  requests.post(f'https://api.telegram.org/bot{TOKEN}/sendMessage', json={'chat_id': CHAT, 'text': msg})
                  print('Fiyat degisti, bildirim gonderildi!')
                  with open('last_notify.txt', 'w') as f:
                      f.write(str(now))
              
              # 6 saat geÃ§ti, hatÄ±rlatma
              elif last_notify and (now - int(last_notify)) >= 21600:
                  msg = f'â° 6 SAATLIK HATIRLATMA\n\nğŸ“¦ ZW Collection Hayvan Desenli KÃ¼rk Kaban\nğŸ’° Fiyat hÃ¢lÃ¢: {formatted}\n\nğŸ“Š Takip devam ediyor, fiyat deÄŸiÅŸmedi.\n\nğŸ”— {URL}'
                  requests.post(f'https://api.telegram.org/bot{TOKEN}/sendMessage', json={'chat_id': CHAT, 'text': msg})
                  print('6 saat hatirlatmasi gonderildi!')
                  with open('last_notify.txt', 'w') as f:
                      f.write(str(now))
              
              else:
                  print('Fiyat ayni, bildirim yok.')

              with open('price.txt', 'w') as f:
                  f.write(str(price))
          "
      
      - name: Commit price
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add price.txt last_notify.txt || true
          git diff --staged --quiet || git commit -m "Update price"
          git push || true
