name: Zara Fiyat Takip

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-price:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests beautifulsoup4
      
      - name: Check price
        run: |
          python << 'PYEND'
          import requests
          import os
          import time
          from bs4 import BeautifulSoup

          # --- AYARLAR ---
          TOKEN = "8375130122:AAHXVaMo-XXZvkd-MEsoOdEVpdtkqc50psg"
          CHAT = "1234645010"
          URL = "https://www.zara.com/tr/tr/hayvan-desenli-kisa-suni-kurk-kaban-zw-collection-p04369240.html?v1=489488534"
          # ---------------

          def send_telegram(message):
              try:
                  url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
                  requests.post(url, json={"chat_id": CHAT, "text": message})
              except Exception as e:
                  print(f"Telegram hatasi: {e}")

          print("Siteye baglaniliyor...")
          
          # Zara gibi siteler icin gelismis basliklar
          headers = {
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
              "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
              "Accept-Language": "tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7",
              "Referer": "https://www.google.com/"
          }

          response = None
          try:
              session = requests.Session()
              response = session.get(URL, headers=headers, timeout=30)
          except Exception as e:
              print(f"Baglanti hatasi: {e}")
              send_telegram(f"‚ö†Ô∏è HATA: Zara sitesine baglanilamadi.\n\nHata: {str(e)}")
              exit(1)

          soup = BeautifulSoup(response.content, 'html.parser')
          price = None

          # 1. Yontem: Meta etiketleri (En saglami)
          meta_price = soup.find("meta", property="product:price:amount")
          if not meta_price:
              meta_price = soup.find("meta", property="og:price:amount")
          
          if meta_price:
              try:
                  price = float(meta_price["content"])
              except:
                  pass

          # 2. Yontem: HTML icinde arama (Yedek)
          if not price:
              # 'price' iceren span elementlerini tara
              candidates = soup.find_all("span", class_=lambda x: x and "price" in x)
              for tag in candidates:
                  text = tag.get_text().strip()
                  # Basit regex mantigi: "3.590,00 TL" formatini yakala
                  if "TL" in text:
                      clean = text.replace("TL", "").replace(".", "").replace(",", ".").strip()
                      try:
                          val = float(clean)
                          if val > 100: # Mantikli bir fiyat mi?
                              price = val
                              break
                      except:
                          continue

          # Eger fiyat hala bulunamadiysa
          if not price:
              print("Fiyat bulunamadi!")
              # Onceki hatayi onlemek icin bos bir price.txt olusturalim
              if not os.path.exists("price.txt"):
                  with open("price.txt", "w") as f: f.write("0")
              
              # Size bildirim gonderiyoruz ki sorunu anlayin
              send_telegram(f"‚ö†Ô∏è DIKKAT: Fiyat sayfadan √ßekilemedi.\n\nSebep: Zara botu engellemis olabilir veya HTML yapisi degismis.\n\nüîó {URL}")
              exit(0) # Kod burada biter

          # Fiyat bulunduysa isleme devam et
          formatted = f"{price:,.2f} TL".replace(",", "X").replace(".", ",").replace("X", ".")
          print(f"Guncel Fiyat: {formatted}")

          last = ""
          last_notify = ""
          
          # Dosyalar yoksa hata vermemesi icin olustur
          if not os.path.exists("price.txt"):
              with open("price.txt", "w") as f: f.write(str(price))
          if not os.path.exists("notify.txt"):
              with open("notify.txt", "w") as f: f.write("")

          with open("price.txt", "r") as f: last = f.read().strip()
          with open("notify.txt", "r") as f: last_notify = f.read().strip()

          now = int(time.time())
          msg = None

          # Ilk calistirma veya fiyat degisimi
          if not last or last == "0":
              msg = f"üõçÔ∏è ZARA TAKƒ∞P AKTƒ∞F!\n\nüí∞ Fiyat: {formatted}\n\nüîó {URL}"
          
          elif float(last) != price:
              old = float(last)
              diff = price - old
              msg = f"üö® Fƒ∞YAT DEƒûƒ∞≈ûTƒ∞!\n\nEski: {old}\nYeni: {formatted}\nFark: {diff}\n\nüîó {URL}"

          # Hatirlatma (6 saatte bir)
          elif last_notify and (now - int(last_notify) if last_notify.isdigit() else 999999) >= 21600:
              msg = f"‚è∞ HATIRLATMA\n\nFiyat hala: {formatted}\n\nüîó {URL}"

          if msg:
              send_telegram(msg)
              with open("notify.txt", "w") as f: f.write(str(now))

          # Fiyati kaydet
          with open("price.txt", "w") as f: f.write(str(price))
          PYEND
      
      - name: Commit files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          # Dosyalar yoksa olustur ki hata vermesin
          touch price.txt notify.txt
          git add -A
          git diff --staged --quiet || git commit -m "Update price"
          git push
