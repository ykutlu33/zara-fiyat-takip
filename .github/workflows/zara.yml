name: Zara Fiyat Takip

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-price:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests playwright beautifulsoup4
          playwright install firefox
          playwright install-deps

      - name: Check price
        run: |
          python << 'PYEND'
          import requests
          import os
          import time
          import json
          import random
          from datetime import datetime
          from bs4 import BeautifulSoup
          from playwright.sync_api import sync_playwright

          # ===== AYARLAR =====
          TOKEN = "8375130122:AAHXVaMo-XXZvkd-MEsoOdEVpdtkqc50psg"
          CHAT  = "1234645010"
          URL   = "https://www.zara.com/tr/tr/cift-tarafli-cift-yuzlu-ceket-p06318254.html"
          # ===================

          def send_telegram(msg):
              url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
              payload = {"chat_id": CHAT, "text": msg}
              try:
                  requests.post(url, json=payload)
              except:
                  pass

          def get_data():
              """Kayitli verileri oku"""
              if os.path.exists("data.json"):
                  try:
                      return json.load(open("data.json"))
                  except:
                      pass
              return {"price": 0, "first_price": 0, "last_check": "", "check_count": 0, "last_reminder": ""}

          def save_data(data):
              """Verileri kaydet"""
              with open("data.json", "w") as f:
                  json.dump(data, f)

          def format_price(p):
              return f"{p:,.2f} TL".replace(",", ".")

          def get_time():
              return datetime.now().strftime("%d.%m.%Y %H:%M")

          # ===== FIYAT CEKME =====
          price = None
          product_name = "Zara Urunu"

          try:
              with sync_playwright() as p:
                  browser = p.firefox.launch(headless=True)
                  context = browser.new_context(
                      user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0"
                  )
                  page = context.new_page()
                  page.goto(URL, timeout=90000, wait_until="domcontentloaded")
                  time.sleep(random.uniform(5, 8))
                  content = page.content()
                  browser.close()

                  soup = BeautifulSoup(content, 'html.parser')

                  # JSON metodu
                  scripts = soup.find_all('script', type='application/ld+json')
                  for script in scripts:
                      try:
                          data = json.loads(script.string)
                          if isinstance(data, list): data = data[0]
                          if data.get('@type') == 'Product':
                              if 'name' in data: product_name = data['name']
                              offers = data.get('offers', {})
                              if isinstance(offers, list): offers = offers[0]
                              if offers.get('price'):
                                  price = float(offers['price'])
                                  break
                      except:
                          continue
                  
                  # CSS metodu (yedek)
                  if not price:
                      candidates = soup.select("span.money-amount__main")
                      for tag in candidates:
                          txt = tag.get_text().strip()
                          clean = txt.replace("TL", "").replace("TRY", "").replace(".", "").replace(",", ".").strip()
                          try:
                              val = float(clean)
                              if val > 100:
                                  price = val
                                  break
                          except:
                              continue

          except Exception as e:
              send_telegram(f"âš ï¸ HATA\n\nSayfa yuklenemedi:\n{str(e)[:150]}\n\nğŸ”— {URL}")
              exit(1)

          if not price:
              send_telegram(f"âš ï¸ UYARI\n\nFiyat bilgisi alinamadi.\nUrun kaldirÄ±lmis veya sayfa degismis olabilir.\n\nğŸ”— {URL}")
              exit(0)

          # ===== MANTIK =====
          db = get_data()
          now = get_time()
          
          # ILK CALISTIRMA
          if db["price"] == 0:
              msg = f"""ğŸ›ï¸ TAKÄ°P BAÅLADI

ğŸ“¦ {product_name}

ğŸ’° GÃ¼ncel Fiyat: {format_price(price)}

ğŸ”— {URL}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â„¹ï¸ Fiyat deÄŸiÅŸirse anÄ±nda bildirim alacaksÄ±nÄ±z.
â° DeÄŸiÅŸiklik olmazsa 6 saatte bir hatÄ±rlatma gelecek.
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""
              
              send_telegram(msg)
              db["price"] = price
              db["first_price"] = price
              db["last_check"] = now
              db["last_reminder"] = now
              db["check_count"] = 1
              save_data(db)
              exit(0)

          # FIYAT DEGISTI
          old_price = db["price"]
          if old_price != price:
              diff = old_price - price
              percent = (diff / old_price) * 100
              
              if price < old_price:
                  # FIYAT DUSTU
                  msg = f"""ğŸ”¥ FÄ°YAT DÃœÅTÃœ!

ğŸ“¦ {product_name}

ğŸ’¸ Eski Fiyat: {format_price(old_price)}
ğŸ’° Yeni Fiyat: {format_price(price)}

ğŸ“‰ DÃ¼ÅŸÃ¼ÅŸ: {format_price(abs(diff))} (-%{abs(percent):.1f})

ğŸ”— {URL}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â° {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""
              else:
                  # FIYAT ARTTI
                  msg = f"""ğŸ“ˆ FÄ°YAT ARTTI

ğŸ“¦ {product_name}

ğŸ’° Eski Fiyat: {format_price(old_price)}
ğŸ’¸ Yeni Fiyat: {format_price(price)}

ğŸ“Š ArtÄ±ÅŸ: {format_price(abs(diff))} (+%{abs(percent):.1f})

ğŸ”— {URL}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â° {now}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""
              
              send_telegram(msg)
              db["price"] = price
              db["last_check"] = now
              db["last_reminder"] = now
              db["check_count"] += 1
              save_data(db)
              exit(0)

          # 6 SAAT HATIRLATMA (12 kontrol x 30dk = 6 saat)
          db["check_count"] += 1
          if db["check_count"] >= 12:
              first_p = db.get("first_price", price)
              total_diff = first_p - price
              
              if total_diff != 0:
                  change_text = f"ğŸ“Š Takip baÅŸlangÄ±cÄ±ndan bu yana: {format_price(abs(total_diff))} {'dÃ¼ÅŸÃ¼ÅŸ' if total_diff > 0 else 'artÄ±ÅŸ'}"
              else:
                  change_text = "ğŸ“Š Takip baÅŸlangÄ±cÄ±ndan bu yana fiyat deÄŸiÅŸmedi"
              
              msg = f"""â° 6 SAATLÄ°K RAPOR

ğŸ“¦ {product_name}

ğŸ’° GÃ¼ncel Fiyat: {format_price(price)}

{change_text}

ğŸ”— {URL}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… Takip aktif - Fiyat deÄŸiÅŸirse bildirim alacaksÄ±nÄ±z
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"""
              
              send_telegram(msg)
              db["check_count"] = 0
              db["last_reminder"] = now
          
          db["last_check"] = now
          save_data(db)
          PYEND

      - name: Commit files
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          touch data.json
          git add -A
          git diff --staged --quiet || git commit -m "Update price data"
          git push
```

## ğŸ“± Bildirim SenaryolarÄ±:

**1ï¸âƒ£ Ä°lk BaÅŸlatma:**
```
ğŸ›ï¸ TAKÄ°P BAÅLADI

ğŸ“¦ Ã‡ift TaraflÄ± Ã‡ift YÃ¼zlÃ¼ Ceket

ğŸ’° GÃ¼ncel Fiyat: 2.990,00 TL

ğŸ”— [link]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â„¹ï¸ Fiyat deÄŸiÅŸirse anÄ±nda bildirim alacaksÄ±nÄ±z.
â° DeÄŸiÅŸiklik olmazsa 6 saatte bir hatÄ±rlatma gelecek.
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**2ï¸âƒ£ Fiyat DÃ¼ÅŸÃ¼nce:**
```
ğŸ”¥ FÄ°YAT DÃœÅTÃœ!

ğŸ“¦ Ã‡ift TaraflÄ± Ã‡ift YÃ¼zlÃ¼ Ceket

ğŸ’¸ Eski Fiyat: 2.990,00 TL
ğŸ’° Yeni Fiyat: 2.490,00 TL

ğŸ“‰ DÃ¼ÅŸÃ¼ÅŸ: 500,00 TL (-%16.7)

ğŸ”— [link]
```

**3ï¸âƒ£ 6 Saatlik HatÄ±rlatma:**
```
â° 6 SAATLÄ°K RAPOR

ğŸ“¦ Ã‡ift TaraflÄ± Ã‡ift YÃ¼zlÃ¼ Ceket

ğŸ’° GÃ¼ncel Fiyat: 2.990,00 TL

ğŸ“Š Takip baÅŸlangÄ±cÄ±ndan bu yana fiyat deÄŸiÅŸmedi

ğŸ”— [link]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… Takip aktif - Fiyat deÄŸiÅŸirse bildirim alacaksÄ±nÄ±z
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
