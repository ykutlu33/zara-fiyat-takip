name: Zara Fiyat Takip

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  check-price:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Run tracker
        env:
          LAST_PRICE: ${{ vars.LAST_PRICE }}
          LAST_NOTIFY: ${{ vars.LAST_NOTIFY }}
        run: |
          cat << 'EOF' > tracker.py
          import requests, re, os, time

          TOKEN = "8375130122:AAHXVaMo-XXZvkd-MEsoOdEVpdtkqc50psg"
          CHAT = "1234645010"
          URL = "https://www.zara.com/tr/tr/hayvan-desenli-kisa-suni-kurk-kaban-zw-collection-p04369240.html?v1=489488534"

          print("Fiyat kontrol ediliyor...")
          
          headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}
          response = requests.get(URL, headers=headers, timeout=30)
          prices = re.findall(r"(\d{1,3}(?:\.\d{3})*,\d{2})\s*TL", response.text)

          print(f"Bulunan fiyatlar: {prices}")

          if prices:
              float_prices = [float(p.replace(".", "").replace(",", ".")) for p in prices]
              price = min(float_prices)
              formatted = f"{price:,.2f} TL".replace(",", "X").replace(".", ",").replace("X", ".")
              print(f"Guncel fiyat: {formatted}")

              last = os.environ.get("LAST_PRICE", "")
              last_notify = os.environ.get("LAST_NOTIFY", "")
              now = int(time.time())
              
              print(f"Onceki fiyat: {last}")
              print(f"Son bildirim: {last_notify}")
              
              msg = None
              
              if not last:
                  msg = f"üõçÔ∏è ZARA Fƒ∞YAT TAKƒ∞Bƒ∞ BA≈ûLADI!\n\nüì¶ ZW Collection Hayvan Desenli K√ºrk Kaban\nüí∞ ≈ûu anki fiyat: {formatted}\n\n‚úÖ Fiyat deƒüi≈üince bildirim alacaksƒ±nƒ±z!\n‚è∞ 6 saatte bir hatƒ±rlatma gelecek.\n\nüîó {URL}"
                  print("Ilk calisma, bildirim gonderiliyor...")
              
              elif float(last) != price:
                  old = float(last)
                  diff = price - old
                  pct = (diff / old) * 100
                  old_fmt = f"{old:,.2f} TL".replace(",", "X").replace(".", ",").replace("X", ".")
                  diff_fmt = f"{abs(diff):,.2f} TL".replace(",", "X").replace(".", ",").replace("X", ".")
                  if diff < 0:
                      msg = f"üéâüìâ FIYAT DUSTU!\n\nüì¶ ZW Collection Hayvan Desenli K√ºrk Kaban\n\nüí∞ Eski: {old_fmt}\nüí∞ Yeni: {formatted}\n\n‚úÖ {diff_fmt} UCUZLADI! ({abs(pct):.1f}%)\n\nüîó {URL}"
                  else:
                      msg = f"üìà‚ö†Ô∏è FIYAT ARTTI!\n\nüì¶ ZW Collection Hayvan Desenli K√ºrk Kaban\n\nüí∞ Eski: {old_fmt}\nüí∞ Yeni: {formatted}\n\n‚ö†Ô∏è {diff_fmt} ZAMLANDI! ({abs(pct):.1f}%)\n\nüîó {URL}"
                  print("Fiyat degisti!")
              
              elif last_notify and (now - int(last_notify)) >= 21600:
                  msg = f"‚è∞ 6 SAATLIK HATIRLATMA\n\nüì¶ ZW Collection Hayvan Desenli K√ºrk Kaban\nüí∞ Fiyat h√¢l√¢: {formatted}\n\nüìä Takip devam ediyor, fiyat deƒüi≈ümedi.\n\nüîó {URL}"
                  print("6 saat gecti, hatirlatma!")
              
              else:
                  print("Fiyat ayni, bildirim yok.")
              
              if msg:
                  r = requests.post(f"https://api.telegram.org/bot{TOKEN}/sendMessage", json={"chat_id": CHAT, "text": msg})
                  print(f"Telegram yaniti: {r.status_code} - {r.text}")
              
              with open("price.txt", "w") as f:
                  f.write(str(price))
              with open("notify.txt", "w") as f:
                  f.write(str(now))
              
              print(f"Kaydedildi: {price}")
          else:
              print("Fiyat bulunamadi!")
          EOF
          python tracker.py
      
      - name: Commit
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add price.txt notify.txt || true
          git diff --staged --quiet || git commit -m "Update"
          git push || true
