name: Zara Fiyat Takip

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  check-price:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Get last price and check
        run: |
          if [ -f price.txt ]; then
            export LAST_PRICE=$(cat price.txt)
          fi
          
          python3 -c "
          import requests, re, os

          TOKEN = '8375130122:AAHXVaMo-XXZvkd-MEsoOdEVpdtkqc50psg'
          CHAT = '1234645010'
          URL = 'https://www.zara.com/tr/tr/hayvan-desenli-kisa-suni-kurk-kaban-zw-collection-p04369240.html?v1=489488534'

          headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
          response = requests.get(URL, headers=headers, timeout=30)
          prices = re.findall(r'(\d{1,3}(?:\.\d{3})*,\d{2})\s*TL', response.text)

          if prices:
              float_prices = [float(p.replace('.', '').replace(',', '.')) for p in prices]
              price = min(float_prices)
              formatted = f'{price:,.2f} TL'.replace(',', 'X').replace('.', ',').replace('X', '.')
              print(f'Fiyat: {formatted}')

              last = os.environ.get('LAST_PRICE', '')
              if last and float(last) != price:
                  old = float(last)
                  diff = price - old
                  pct = (diff / old) * 100
                  old_fmt = f'{old:,.2f} TL'.replace(',', 'X').replace('.', ',').replace('X', '.')
                  diff_fmt = f'{abs(diff):,.2f} TL'.replace(',', 'X').replace('.', ',').replace('X', '.')
                  if diff < 0:
                      msg = f'ðŸŽ‰ðŸ“‰ FIYAT DUSTU!\n\nEski: {old_fmt}\nYeni: {formatted}\n\nFark: {diff_fmt} ({abs(pct):.1f}%)\n\n{URL}'
                  else:
                      msg = f'ðŸ“ˆ FIYAT ARTTI!\n\nEski: {old_fmt}\nYeni: {formatted}\n\nFark: {diff_fmt} ({abs(pct):.1f}%)\n\n{URL}'
                  requests.post(f'https://api.telegram.org/bot{TOKEN}/sendMessage', json={'chat_id': CHAT, 'text': msg})
                  print('Telegram gonderildi!')

              with open('price.txt', 'w') as f:
                  f.write(str(price))
          "
      
      - name: Commit price
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add price.txt || true
          git diff --staged --quiet || git commit -m "Update price"
          git push || true
