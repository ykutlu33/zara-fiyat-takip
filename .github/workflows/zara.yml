name: Zara Fiyat Takip

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-price:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests playwright beautifulsoup4
          playwright install firefox
          playwright install-deps

      - name: Check price
        run: |
          python << 'PYEND'
          import requests
          import os
          import time
          import json
          import random
          from datetime import datetime
          from bs4 import BeautifulSoup
          from playwright.sync_api import sync_playwright

          TOKEN = "8375130122:AAHXVaMo-XXZvkd-MEsoOdEVpdtkqc50psg"
          GROUP_CHAT = "-5170519870"
          PERSONAL_CHAT = "1234645010"
          URL = "https://www.zara.com/tr/tr/cift-tarafli-cift-yuzlu-ceket-p06318254.html"

          def send_telegram(msg, chat_id):
              url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
              payload = {"chat_id": chat_id, "text": msg}
              try:
                  resp = requests.post(url, json=payload, timeout=30)
                  print(f"Telegram response: {resp.status_code}")
              except Exception as e:
                  print(f"Telegram error: {e}")

          def get_data():
              if os.path.exists("data.json"):
                  try:
                      with open("data.json", "r") as f:
                          data = json.load(f)
                          print(f"Loaded data: {data}")
                          return data
                  except Exception as e:
                      print(f"JSON read error: {e}")
              return None

          def save_data(data):
              with open("data.json", "w") as f:
                  json.dump(data, f, indent=2)
              print(f"Saved data: {data}")

          def format_price(p):
              return f"{p:,.2f} TL".replace(",", "X").replace(".", ",").replace("X", ".")

          def get_time():
              from datetime import timezone, timedelta
              tr_tz = timezone(timedelta(hours=3))
              return datetime.now(tr_tz).strftime("%d.%m.%Y %H:%M")

          price = None
          product_name = "Zara ÃœrÃ¼nÃ¼"

          try:
              with sync_playwright() as p:
                  browser = p.firefox.launch(headless=True)
                  context = browser.new_context(
                      user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0",
                      locale="tr-TR"
                  )
                  page = context.new_page()
                  page.goto(URL, timeout=90000, wait_until="domcontentloaded")
                  time.sleep(random.uniform(6, 10))
                  content = page.content()
                  browser.close()

                  soup = BeautifulSoup(content, "html.parser")

                  # JSON-LD'den fiyat al
                  scripts = soup.find_all("script", type="application/ld+json")
                  for script in scripts:
                      try:
                          data = json.loads(script.string)
                          if isinstance(data, list):
                              data = data[0]
                          if data.get("@type") == "Product":
                              if "name" in data:
                                  product_name = data["name"]
                              offers = data.get("offers", {})
                              if isinstance(offers, list):
                                  offers = offers[0]
                              if offers.get("price"):
                                  price = float(offers["price"])
                                  print(f"JSON-LD'den fiyat: {price}")
                                  break
                      except:
                          continue
                  
                  # HTML'den fiyat al (yedek)
                  if not price:
                      candidates = soup.select("span.money-amount__main")
                      for tag in candidates:
                          txt = tag.get_text().strip()
                          clean = txt.replace("TL", "").replace("TRY", "").replace(".", "").replace(",", ".").strip()
                          try:
                              val = float(clean)
                              if val > 100:
                                  price = val
                                  print(f"HTML'den fiyat: {price}")
                                  break
                          except:
                              continue

          except Exception as e:
              error_msg = f"âŒ HATA\n\n{str(e)[:200]}\n\nâ° {get_time()}"
              send_telegram(error_msg, PERSONAL_CHAT)
              exit(1)

          if not price:
              send_telegram(f"âš ï¸ Fiyat alÄ±namadÄ±\n\nðŸ”— {URL}\n\nâ° {get_time()}", PERSONAL_CHAT)
              exit(0)

          print(f"GÃ¼ncel fiyat: {price}")

          db = get_data()
          now = get_time()
          
          # Ä°LK Ã‡ALIÅžTIRMA veya SIFIRDAN BAÅžLAMA
          if db is None or db.get("price", 0) == 0:
              msg = f"ðŸ›ï¸ YENÄ° ÃœRÃœN TAKÄ°BÄ°\n"
              msg += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
              msg += f"ðŸ“¦ {product_name}\n\n"
              msg += f"ðŸ’° GÃ¼ncel Fiyat: {format_price(price)}\n\n"
              msg += f"ðŸ”— {URL}\n\n"
              msg += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
              msg += f"â„¹ï¸ Fiyat deÄŸiÅŸirse gruba bildirim gelecek\n"
              msg += f"â° 6 saatte bir durum raporu paylaÅŸÄ±lacak"
              
              send_telegram(msg, GROUP_CHAT)
              
              new_db = {
                  "price": price,
                  "first_price": price,
                  "lowest_price": price,
                  "highest_price": price,
                  "check_count": 0,
                  "start_date": now
              }
              save_data(new_db)
              exit(0)

          old_price = db["price"]
          print(f"Eski fiyat: {old_price}, Yeni fiyat: {price}")
          
          # FÄ°YAT DEÄžÄ°ÅžTÄ°
          if abs(old_price - price) > 0.01:  # kÃ¼Ã§Ã¼k farklarÄ± yoksay
              diff = old_price - price
              percent = (diff / old_price) * 100
              
              if price < db["lowest_price"]:
                  db["lowest_price"] = price
              if price > db["highest_price"]:
                  db["highest_price"] = price
              
              if price < old_price:
                  msg = f"ðŸ”¥ FÄ°YAT DÃœÅžTÃœ! ðŸ”¥\n"
                  msg += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
                  msg += f"ðŸ“¦ {product_name}\n\n"
                  msg += f"ðŸ’¸ Eski Fiyat: {format_price(old_price)}\n"
                  msg += f"ðŸ’° Yeni Fiyat: {format_price(price)}\n\n"
                  msg += f"ðŸ“‰ DÃ¼ÅŸÃ¼ÅŸ: {format_price(abs(diff))} (-%{abs(percent):.1f})\n\n"
                  msg += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
                  msg += f"ðŸ“Š Takipteki en dÃ¼ÅŸÃ¼k: {format_price(db['lowest_price'])}\n"
                  msg += f"ðŸ“Š Takipteki en yÃ¼ksek: {format_price(db['highest_price'])}\n\n"
                  msg += f"ðŸ”— {URL}\n\n"
                  msg += f"â° {now}"
              else:
                  msg = f"ðŸ“ˆ FÄ°YAT ARTTI\n"
                  msg += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
                  msg += f"ðŸ“¦ {product_name}\n\n"
                  msg += f"ðŸ’° Eski Fiyat: {format_price(old_price)}\n"
                  msg += f"ðŸ’¸ Yeni Fiyat: {format_price(price)}\n\n"
                  msg += f"ðŸ“ˆ ArtÄ±ÅŸ: {format_price(abs(diff))} (+%{abs(percent):.1f})\n\n"
                  msg += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
                  msg += f"ðŸ“Š Takipteki en dÃ¼ÅŸÃ¼k: {format_price(db['lowest_price'])}\n"
                  msg += f"ðŸ“Š Takipteki en yÃ¼ksek: {format_price(db['highest_price'])}\n\n"
                  msg += f"ðŸ”— {URL}\n\n"
                  msg += f"â° {now}"
              
              send_telegram(msg, GROUP_CHAT)
              db["price"] = price
              db["check_count"] = 0
              save_data(db)
              exit(0)

          # FÄ°YAT AYNI - SAYACI ARTIR
          db["check_count"] = db.get("check_count", 0) + 1
          print(f"Check count: {db['check_count']}/24")

          # 6 SAAT RAPOR (24 x 15dk = 6 saat)
          if db["check_count"] >= 24:
              first_p = db.get("first_price", price)
              total_diff = first_p - price
              
              msg = f"â° 6 SAATLÄ°K RAPOR\n"
              msg += f"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
              msg += f"ðŸ“¦ {product_name}\n\n"
              msg += f"ðŸ’° GÃ¼ncel Fiyat: {format_price(price)}\n\n"
              
              if total_diff > 0.01:
                  msg += f"ðŸ“‰ BaÅŸlangÄ±Ã§tan bu yana: {format_price(abs(total_diff))} dÃ¼ÅŸÃ¼ÅŸ\n"
              elif total_diff < -0.01:
                  msg += f"ðŸ“ˆ BaÅŸlangÄ±Ã§tan bu yana: {format_price(abs(total_diff))} artÄ±ÅŸ\n"
              else:
                  msg += f"âž– BaÅŸlangÄ±Ã§tan bu yana fiyat deÄŸiÅŸmedi\n"
              
              msg += f"\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
              msg += f"ðŸ“Š En dÃ¼ÅŸÃ¼k: {format_price(db['lowest_price'])}\n"
              msg += f"ðŸ“Š En yÃ¼ksek: {format_price(db['highest_price'])}\n"
              msg += f"ðŸ“… Takip baÅŸlangÄ±cÄ±: {db.get('start_date', '-')}\n\n"
              msg += f"ðŸ”— {URL}\n\n"
              msg += f"âœ… Takip aktif"
              
              send_telegram(msg, GROUP_CHAT)
              db["check_count"] = 0

          save_data(db)
          PYEND

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # data.json'Ä± kontrol et
          if [ -f "data.json" ]; then
            cat data.json
          fi
          
          # DeÄŸiÅŸiklik varsa commit et
          git add data.json
          if ! git diff --staged --quiet; then
            git commit -m "Update price data [skip ci]"
            
            # Push et, conflict varsa tekrar dene
            for i in 1 2 3; do
              git push && break
              echo "Push failed, retrying..."
              git pull --rebase
            done
          else
            echo "No changes to commit"
          fi
